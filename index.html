<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Brawl Web</title>

<style>
html,body{
  margin:0;
  padding:0;
  overflow:hidden;
  background:black;
}
canvas{
  display:block;
}

/* Ï°∞Ïù¥Ïä§Ìã± */
#joystick{
  position:fixed;
  left:20px;
  bottom:120px;
  width:120px;
  height:120px;
  border-radius:50%;
  background:rgba(255,255,255,0.15);
  border:2px solid rgba(255,255,255,0.4);
  touch-action:none;
}
#stick{
  position:absolute;
  left:40px;
  top:40px;
  width:40px;
  height:40px;
  border-radius:50%;
  background:rgba(255,255,255,0.85);
}

/* Î≤ÑÌäº */
button{
  position:fixed;
  width:70px;
  height:70px;
  border-radius:50%;
  border:none;
  font-size:30px;
  z-index:10;
  opacity:0.85;
}
#atkBtn{
  left:20px;
  bottom:20px;
  background:crimson;
  color:white;
}
#ultBtn{
  right:20px;
  bottom:20px;
  background:orange;
}
button:disabled{
  opacity:0.3;
}
</style>
</head>

<body>
<canvas id="game"></canvas>

<div id="joystick"><div id="stick"></div></div>
<button id="atkBtn">üëä</button>
<button id="ultBtn">üí•</button>

<audio id="bgm" src="bgm_battle.mp3" loop></audio>
<audio id="bgmWin" src="bgm_win.mp3"></audio>
<audio id="bgmLose" src="bgm_lose.mp3"></audio>

<script>
/* ===== Í∏∞Î≥∏ ===== */
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
function resize(){
  canvas.width = innerWidth;
  canvas.height = innerHeight;
}
addEventListener("resize",resize);
resize();

const bgImg = new Image();
bgImg.src = "background.jpg";

const playerImg = new Image();
playerImg.src = "player.jpg";

const bgm = document.getElementById("bgm");
const bgmWin = document.getElementById("bgmWin");
const bgmLose = document.getElementById("bgmLose");
bgm.play();

/* ===== ÏÉÅÌÉú ===== */
let gameState="play";

/* ===== ÌîåÎ†àÏù¥Ïñ¥ ===== */
const player={
  x:canvas.width/2,
  y:canvas.height*0.7,
  r:20,
  speed:3,
  hp:100,
  maxHp:100,
  attackRange:35,
  attackDamage:12,
  attackCooldown:0,
  ult:100,
  ultReady:true,
  ultCooldown:0
};

/* ===== AI ===== */
const AIs=[];
for(let i=0;i<4;i++){
  AIs.push({
    x:Math.random()*canvas.width,
    y:Math.random()*canvas.height*0.5,
    r:18,
    speed:2,
    hp:60,
    team:i<2?"A":"B",
    attackRange:30,
    attackDamage:10,
    attackCooldown:0,
    aimDX:0,
    aimDY:1
  });
}

/* ===== Ï°∞Ïù¥Ïä§Ìã± ===== */
const joystick=document.getElementById("joystick");
const stick=document.getElementById("stick");
let joyDX=0, joyDY=0, joyActive=false;
let aimDX=0, aimDY=1;

joystick.addEventListener("touchstart",()=>joyActive=true);
joystick.addEventListener("touchmove",e=>{
  if(!joyActive) return;
  const r=joystick.getBoundingClientRect();
  let x=e.touches[0].clientX-r.left-60;
  let y=e.touches[0].clientY-r.top-60;
  const d=Math.hypot(x,y);
  if(d>40){ x*=40/d; y*=40/d; }
  joyDX=x/40; joyDY=y/40;
  aimDX=joyDX; aimDY=joyDY;
  stick.style.left=(x+40)+"px";
  stick.style.top=(y+40)+"px";
});
joystick.addEventListener("touchend",()=>{
  joyDX=joyDY=0; joyActive=false;
  stick.style.left="40px"; stick.style.top="40px";
});

/* ===== Î≤ÑÌäº ===== */
const atkBtn=document.getElementById("atkBtn");
const ultBtn=document.getElementById("ultBtn");

atkBtn.onclick=()=>{
  if(player.attackCooldown>0||gameState!=="play")return;
  for(const ai of AIs){
    if(ai.hp<=0)continue;
    const dx=ai.x-player.x, dy=ai.y-player.y;
    const d=Math.hypot(dx,dy);
    if(d<player.attackRange+ai.r){
      const dot=(dx/d)*aimDX+(dy/d)*aimDY;
      if(dot>0.5) ai.hp-=player.attackDamage;
    }
  }
  player.attackCooldown=25;
};

ultBtn.onclick=()=>{
  if(!player.ultReady||gameState!=="play")return;
  for(const ai of AIs){
    const d=Math.hypot(ai.x-player.x, ai.y-player.y);
    if(d<90) ai.hp-=35;
  }
  player.ult=0;
  player.ultReady=false;
  player.ultCooldown=300;
};

/* ===== AI ÏóÖÎç∞Ïù¥Ìä∏ ===== */
function updateAI(ai){
  if(ai.hp<=0)return;
  let target=player, min=9999;
  for(const o of AIs){
    if(o!==ai&&o.team!==ai.team&&o.hp>0){
      const d=Math.hypot(o.x-ai.x,o.y-ai.y);
      if(d<min){min=d;target=o;}
    }
  }
  const dx=target.x-ai.x, dy=target.y-ai.y;
  const dist=Math.hypot(dx,dy);
  ai.aimDX=dx/dist; ai.aimDY=dy/dist;
  if(dist>ai.attackRange){
    ai.x+=ai.aimDX*ai.speed;
    ai.y+=ai.aimDY*ai.speed;
  }
  if(dist<ai.attackRange+target.r && ai.attackCooldown<=0){
    target.hp-=ai.attackDamage;
    ai.attackCooldown=30;
  }
  if(ai.attackCooldown>0) ai.attackCooldown--;
}

/* ===== Í≤åÏûÑ Î£®ÌîÑ ===== */
function loop(){
  ctx.drawImage(bgImg,0,0,canvas.width,canvas.height);

  player.x+=joyDX*player.speed;
  player.y+=joyDY*player.speed;

  if(player.attackCooldown>0) player.attackCooldown--;
  if(player.ult<100) player.ult+=0.2;
  else player.ultReady=true;
  if(player.ultCooldown>0) player.ultCooldown--;

  for(const ai of AIs) updateAI(ai);

  // ÌîåÎ†àÏù¥Ïñ¥
  ctx.drawImage(playerImg,player.x-25,player.y-25,50,50);

  // Ï≤¥Î†•Î∞î
  ctx.fillStyle="red";
  ctx.fillRect(player.x-25,player.y-35,50*(player.hp/player.maxHp),5);

  // AI
  for(const ai of AIs){
    if(ai.hp<=0)continue;
    ctx.fillStyle=ai.team==="A"?"blue":"orange";
    ctx.beginPath();
    ctx.arc(ai.x,ai.y,ai.r,0,Math.PI*2);
    ctx.fill();
  }

  requestAnimationFrame(loop);
}
loop();
</script>
</body>
</html>
